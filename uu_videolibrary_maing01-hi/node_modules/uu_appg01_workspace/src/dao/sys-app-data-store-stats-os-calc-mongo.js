const { DbConnection } = require("uu_appg01_datastore");

class SysAppDataStoreStatsOsCalcMongo {
  constructor(connectionString) {
    this.connectionString = connectionString;
    DbConnection.init(connectionString);
  }

  async calculate(awid, collectionName) {
    let db = await DbConnection.get(this.connectionString);
    let collectionInfo;

    collectionInfo = await db
      .collection(collectionName)
      .mapReduce(
        "function () {" + "emit(0, {count: 1, size: Object.bsonsize(this)});" + "}",
        "function (k, infos) {" +
          "var count = 0;" +
          "var size = 0;" +
          "infos.forEach(function (info) {" +
          "count += info.count;" +
          "size += info.size;" +
          "});" +
          "return {count: count, size: size};" +
          "}",
        { out: { inline: 1 }, query: { awid } }
      );

    let objectStats;
    if (!collectionInfo[0]) {
      objectStats = { count: 0, size: 0 };
    } else {
      objectStats = collectionInfo[0].value;
    }

    if (objectStats["count"] > 0) {
      let collStats;
      collStats = await db.command({ collStats: collectionName });

      let totalIndexSize = collStats["totalIndexSize"];
      let totalCount = collStats["count"];
      objectStats["size"] += (totalIndexSize / totalCount) * objectStats["count"];
    }

    return objectStats;
  }
}

module.exports = SysAppDataStoreStatsOsCalcMongo;
